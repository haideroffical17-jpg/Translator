<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Creator Studio - TTS Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }
        
        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-[#0B1120] text-white font-sans min-h-screen">

    <!-- APP CONTAINER -->
    <div id="app-root"></div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- CONFIGURATION ---
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const CHUNK_SIZE = 4000;
        
        const VOICES = [
            { id: "Fenrir", gender: "Male", desc: "Deep & Calm" },
            { id: "Kore", gender: "Female", desc: "Soothing & Clear" },
            { id: "Puck", gender: "Male", desc: "Energetic" },
            { id: "Aoede", gender: "Female", desc: "Warm & Friendly" },
            { id: "Charon", gender: "Male", desc: "Deep & Authoritative" },
            { id: "Zephyr", gender: "Male", desc: "Smooth & Balanced" },
            { id: "Leda", gender: "Female", desc: "Soft & Gentle" },
            { id: "Orus", gender: "Male", desc: "Confident" },
            { id: "Umbriel", gender: "Male", desc: "Steady & Neutral" },
            { id: "Iapetus", gender: "Male", desc: "Serious & Deep" }
        ];

        // --- STATE MANAGEMENT ---
        const state = {
            view: 'home', // 'home' | 'tts'
            text: "",
            selectedVoiceId: "Fenrir",
            isGenerating: false,
            audioUrl: null,
            previewAudio: null,
            apiKeys: JSON.parse(localStorage.getItem("multi_api_keys") || "[]"),
            showSettings: false,
            progress: 0,
            error: null,
            speed: 1.0,
            currentKeyIndex: 0
        };

        // --- RENDER FUNCTIONS ---

        function init() {
            render();
        }

        function render() {
            const root = document.getElementById('app-root');
            root.innerHTML = '';

            if (state.view === 'home') {
                root.innerHTML = renderLandingPage();
            } else if (state.view === 'tts') {
                root.innerHTML = renderTTSProTool();
                // Re-attach event listeners for TTS page specifically if needed for inputs
                const textarea = document.getElementById('text-input');
                if(textarea) {
                    textarea.value = state.text;
                    textarea.addEventListener('input', (e) => {
                        state.text = e.target.value;
                        document.getElementById('char-count').innerText = `${state.text.length} characters`;
                    });
                }
            }

            // Initialize Icons
            lucide.createIcons();
        }

        // --- HTML TEMPLATES ---

        function renderLandingPage() {
            return `
            <div class="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden fade-in">
                <!-- Background Glows -->
                <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-indigo-900/20 rounded-full blur-3xl pointer-events-none"></div>
                <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-emerald-900/20 rounded-full blur-3xl pointer-events-none"></div>

                <!-- Header Badge -->
                <div class="bg-[#1E293B] border border-slate-700/50 px-4 py-1.5 rounded-full text-[10px] font-bold tracking-widest text-indigo-300 uppercase mb-6 shadow-lg">
                    Powered by Grow with Haider
                </div>

                <!-- Title -->
                <div class="text-center mb-16 space-y-2">
                    <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-white">AI Creator Studio</h1>
                    <p class="text-slate-400 text-lg font-medium">Professional Tools Suite</p>
                </div>

                <!-- Card -->
                <div class="w-full max-w-md">
                    <div onclick="navigate('tts')" class="group relative bg-[#162032] border border-slate-800 rounded-3xl p-10 hover:border-emerald-500/50 transition-all duration-300 hover:shadow-2xl hover:shadow-emerald-900/20 cursor-pointer transform hover:-translate-y-1">
                        <div class="absolute inset-0 bg-gradient-to-b from-emerald-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-3xl"></div>
                        <div class="flex flex-col items-center text-center space-y-8 relative z-10">
                            <div class="w-20 h-20 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-500/30 group-hover:scale-110 transition-transform duration-300">
                                <i data-lucide="mic" class="w-10 h-10 text-white"></i>
                            </div>
                            <div class="space-y-3">
                                <h3 class="text-2xl font-bold text-white">Text to Speech Pro</h3>
                                <p class="text-slate-400 text-base leading-relaxed">30+ Premium Voices. Unlimited Text. <br/>Instant WAV Download.</p>
                            </div>
                            <button class="flex items-center gap-2 px-6 py-2 bg-emerald-500/10 text-emerald-400 rounded-full text-sm font-bold group-hover:bg-emerald-500 group-hover:text-white transition-all">
                                Open Tool <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderTTSProTool() {
            // Helper to render Voice List
            const voicesHtml = VOICES.map(voice => `
                <div onclick="selectVoice('${voice.id}')" 
                     class="p-3 rounded-xl cursor-pointer transition-all flex items-center justify-between group ${state.selectedVoiceId === voice.id ? 'bg-emerald-600/20 border border-emerald-500/50' : 'hover:bg-slate-800 border border-transparent'}">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${state.selectedVoiceId === voice.id ? 'bg-emerald-500 text-white' : 'bg-slate-700 text-slate-400'}">
                            ${voice.id[0]}
                        </div>
                        <div>
                            <h4 class="text-sm font-bold ${state.selectedVoiceId === voice.id ? 'text-emerald-400' : 'text-slate-300'}">${voice.id}</h4>
                            <p class="text-[10px] text-slate-500">${voice.gender} â€¢ ${voice.desc}</p>
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); previewVoice('${voice.id}')" class="p-2 rounded-full hover:bg-slate-700 text-slate-400 hover:text-emerald-400 transition-colors">
                        <i data-lucide="play" class="w-3 h-3 fill-current"></i>
                    </button>
                </div>
            `).join('');

            return `
            <div class="min-h-screen bg-[#0B1120] text-slate-200 font-sans flex flex-col fade-in">
                <!-- Navbar -->
                <div class="border-b border-slate-800 bg-[#0F172A]/80 backdrop-blur-md sticky top-0 z-20">
                    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
                        <button onclick="navigate('home')" class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i> Back
                        </button>
                        <h1 class="text-lg font-bold text-white flex items-center gap-2">
                            <span class="bg-emerald-500/10 text-emerald-400 p-1.5 rounded-lg"><i data-lucide="mic" class="w-4 h-4"></i></span>
                            Text to Speech Pro
                        </h1>
                        <button onclick="toggleSettings()" class="p-2 rounded-full hover:bg-slate-800 text-slate-400 transition-colors">
                            <i data-lucide="settings" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- Settings Modal -->
                ${state.showSettings ? `
                <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-start justify-center pt-20 fade-in">
                    <div class="bg-[#1E293B] border border-slate-700 rounded-2xl p-6 w-full max-w-md shadow-2xl">
                        <h3 class="text-white font-bold mb-4 flex items-center gap-2"><i data-lucide="key" class="w-4 h-4 text-indigo-400"></i> API Key Manager</h3>
                        <div class="space-y-3">
                            <input id="api-key-input" type="password" placeholder="Paste Gemini API Key..." class="w-full bg-[#0B1120] border border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo-500 text-white" />
                            <div class="flex gap-2">
                                <button onclick="saveKey()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded-xl text-sm font-bold">Add Key</button>
                                <button onclick="toggleSettings()" class="px-4 bg-slate-700 hover:bg-slate-600 text-white rounded-xl text-sm">Close</button>
                            </div>
                            <div class="text-xs text-slate-500 pt-2">
                                Active Keys: ${state.apiKeys.length} (Auto-rotate enabled)
                                ${state.apiKeys.length > 0 ? `<button onclick="clearKeys()" class="text-red-400 ml-2 hover:underline">Clear All</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Main Grid -->
                <div class="flex-1 p-4 md:p-8 max-w-5xl mx-auto w-full grid lg:grid-cols-2 gap-6">
                    
                    <!-- Left: Input -->
                    <div class="flex flex-col gap-4">
                        <div class="bg-[#1E293B] border border-slate-700 rounded-3xl p-1 flex-1 flex flex-col shadow-xl">
                            <textarea id="text-input" placeholder="Paste your script here..." class="flex-1 w-full bg-transparent text-lg p-6 resize-none outline-none text-slate-200 placeholder:text-slate-600 custom-scrollbar">${state.text}</textarea>
                            <div class="px-6 py-3 border-t border-slate-700/50 text-right text-xs text-slate-500 font-mono">
                                <span id="char-count">${state.text.length} characters</span>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Controls -->
                    <div class="flex flex-col gap-4">
                        <div class="bg-[#1E293B] border border-slate-700 rounded-3xl overflow-hidden flex flex-col h-[450px] shadow-xl">
                            <!-- Header -->
                            <div class="px-6 py-4 border-b border-slate-700 bg-[#1E293B] sticky top-0 z-10 flex justify-between items-center">
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Controls</span>
                                <i data-lucide="sliders" class="w-4 h-4 text-slate-500"></i>
                            </div>

                            <!-- Speed Slider -->
                            <div class="p-6 space-y-6 bg-[#162032] border-b border-slate-700">
                                <div>
                                    <div class="flex justify-between mb-2 text-xs font-medium">
                                        <span class="text-slate-400 uppercase">Speed (Preview Only)</span>
                                        <span class="text-emerald-400" id="speed-display">${state.speed}x</span>
                                    </div>
                                    <input type="range" min="0.5" max="2.0" step="0.1" value="${state.speed}" oninput="updateSpeed(this.value)" class="w-full h-1 bg-slate-700 rounded-full appearance-none cursor-pointer accent-emerald-500">
                                </div>
                            </div>

                            <div class="px-6 py-2 bg-[#1E293B] text-xs font-bold text-slate-400 uppercase tracking-wider">Voices</div>
                            <div class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                                ${voicesHtml}
                            </div>
                        </div>

                        <!-- Action Box -->
                        <div class="bg-[#1E293B] border border-slate-700 rounded-3xl p-6 shadow-xl relative overflow-hidden">
                            <div class="absolute -top-10 -right-10 w-32 h-32 bg-emerald-500/20 rounded-full blur-3xl"></div>
                            
                            <div class="relative z-10 space-y-4">
                                ${state.isGenerating ? `
                                <div class="space-y-2">
                                    <div class="flex justify-between text-xs font-bold text-emerald-400">
                                        <span>Generating...</span>
                                        <span>${state.progress}%</span>
                                    </div>
                                    <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                        <div class="h-full bg-emerald-500 transition-all duration-300" style="width: ${state.progress}%"></div>
                                    </div>
                                </div>
                                ` : `
                                <button onclick="generateAudio()" class="w-full py-4 bg-emerald-500 hover:bg-emerald-400 text-[#0B1120] font-bold rounded-xl shadow-lg shadow-emerald-900/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                                    <i data-lucide="wand-2" class="w-5 h-5"></i> Generate Audio
                                </button>
                                `}

                                ${state.audioUrl && !state.isGenerating ? `
                                <div class="animate-in fade-in slide-in-from-bottom-2 space-y-3 pt-2">
                                    <div class="bg-slate-900/50 p-2 rounded-xl border border-slate-700">
                                        <audio controls src="${state.audioUrl}" class="w-full h-8 opacity-80"></audio>
                                    </div>
                                    <a href="${state.audioUrl}" download="tts-${state.selectedVoiceId}-${Date.now()}.wav" class="flex items-center justify-center gap-2 w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-medium transition-colors">
                                        <i data-lucide="download" class="w-4 h-4"></i> Download File
                                    </a>
                                </div>
                                ` : ''}

                                ${state.error ? `
                                <div class="bg-red-500/10 border border-red-500/20 p-3 rounded-xl flex gap-2 items-start text-xs text-red-400">
                                    <i data-lucide="alert-circle" class="w-4 h-4 flex-shrink-0 mt-0.5"></i>
                                    <p>${state.error}</p>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        // --- ACTIONS & LOGIC ---

        function navigate(view) {
            state.view = view;
            render();
        }

        function toggleSettings() {
            state.showSettings = !state.showSettings;
            render();
        }

        function saveKey() {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            if (key) {
                state.apiKeys.push(key);
                localStorage.setItem("multi_api_keys", JSON.stringify(state.apiKeys));
                alert("Key Added!");
                render();
            }
        }

        function clearKeys() {
            state.apiKeys = [];
            localStorage.removeItem("multi_api_keys");
            render();
        }

        function selectVoice(id) {
            state.selectedVoiceId = id;
            render();
        }

        function updateSpeed(val) {
            state.speed = val;
            document.getElementById('speed-display').innerText = val + 'x';
        }

        // --- AUDIO GENERATION LOGIC ---

        async function previewVoice(voiceId) {
            if (state.apiKeys.length === 0) {
                state.showSettings = true;
                render();
                return;
            }

            if (state.previewAudio) {
                state.previewAudio.pause();
                state.previewAudio = null;
            }

            try {
                const buffer = await fetchWithRotation("Hello, testing voice.", voiceId);
                const blob = createWavFromBuffer(buffer);
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                audio.playbackRate = state.speed;
                
                audio.play().catch(e => {
                    console.error("Play error", e);
                    state.error = "Playback failed: " + e.message;
                    render();
                });
                state.previewAudio = audio;
            } catch (err) {
                state.error = "Preview failed: " + err.message;
                render();
            }
        }

        async function generateAudio() {
            if (!state.text.trim()) return;
            if (state.apiKeys.length === 0) {
                state.showSettings = true;
                state.error = "Please add an API Key first!";
                render();
                return;
            }

            state.isGenerating = true;
            state.progress = 0;
            state.error = null;
            state.audioUrl = null;
            render();

            try {
                const chunks = chunkText(state.text);
                const buffers = [];

                for (let i = 0; i < chunks.length; i++) {
                    const chunk = chunks[i];
                    const buffer = await fetchWithRotation(chunk, state.selectedVoiceId);
                    buffers.push(buffer);
                    state.progress = Math.round(((i + 1) / chunks.length) * 100);
                    render();
                }

                const finalBlob = mergeBuffers(buffers);
                state.audioUrl = URL.createObjectURL(finalBlob);

            } catch (err) {
                state.error = err.message;
            } finally {
                state.isGenerating = false;
                render();
            }
        }

        async function fetchWithRotation(text, voiceId) {
            let attempts = 0;
            while (attempts < state.apiKeys.length) {
                const key = state.apiKeys[state.currentKeyIndex];
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${key}`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: {
                                    voiceConfig: {
                                        prebuiltVoiceConfig: { voiceName: voiceId }
                                    }
                                }
                            }
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 429 || response.status === 403) {
                            state.currentKeyIndex = (state.currentKeyIndex + 1) % state.apiKeys.length;
                            attempts++;
                            continue;
                        }
                        throw new Error(await response.text());
                    }

                    const data = await response.json();
                    const b64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (!b64) throw new Error("No audio returned");

                    const bin = atob(b64);
                    const bytes = new Uint8Array(bin.length);
                    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
                    return bytes.buffer;

                } catch (e) {
                    if (e.message.includes("Quota")) {
                        state.currentKeyIndex = (state.currentKeyIndex + 1) % state.apiKeys.length;
                        attempts++;
                    } else {
                        throw e;
                    }
                }
            }
            throw new Error("All API Keys exhausted.");
        }

        // --- UTILS (WAV Processing) ---

        function chunkText(str) {
            const chunks = [];
            let current = "";
            const sentences = str.match(/[^.!?]+[.!?]+|[^.!?]+$/g) || [str];
            sentences.forEach(s => {
                if(current.length + s.length < CHUNK_SIZE) current += s;
                else { if(current) chunks.push(current); current = s; }
            });
            if(current) chunks.push(current);
            return chunks;
        }

        function isWav(buffer) {
            if (buffer.byteLength < 4) return false;
            const view = new DataView(buffer);
            return view.getUint32(0, false) === 0x52494646; // 'RIFF'
        }

        function findDataOffset(buffer) {
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.length - 4; i++) {
                if (bytes[i]===0x64 && bytes[i+1]===0x61 && bytes[i+2]===0x74 && bytes[i+3]===0x61) {
                    return i + 8;
                }
            }
            return 44;
        }

        function mergeBuffers(buffers) {
            if (buffers.length === 0) return new Blob([]);
            
            let totalDataLen = 0;
            const parts = [];

            buffers.forEach(b => {
                let offset = 0;
                if (isWav(b)) {
                    offset = findDataOffset(b);
                }
                const chunkData = b.slice(offset);
                parts.push(chunkData);
                totalDataLen += chunkData.byteLength;
            });
            
            const header = createWavHeader(totalDataLen);
            return new Blob([header, ...parts], { type: 'audio/wav' });
        }

        function createWavFromBuffer(buffer) {
            if (isWav(buffer)) return new Blob([buffer], { type: 'audio/wav' });
            const header = createWavHeader(buffer.byteLength);
            return new Blob([header, buffer], { type: 'audio/wav' });
        }

        function createWavHeader(len) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + len, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, 24000, true);
            view.setUint32(28, 48000, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, len, true);
            return buffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
        }

        // --- INIT ---
        init();

    </script>
</body>
</html>
