<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Voice Clone App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--border:#1f2937;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu; background:var(--bg); color:var(--text);
    }
    .container{max-width:960px;margin:32px auto;padding:0 16px}
    .title{font-size:28px;font-weight:700;margin:0 0 8px}
    .sub{color:var(--muted);margin:0 0 24px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{
      background:linear-gradient(180deg,#0b1220 0%, #0b1220 65%, #0a131f 100%);
      border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    h2{margin:0 0 12px;font-size:20px}
    label{display:block;margin:10px 0 6px;color:#cbd5e1}
    input[type="text"], textarea, select{
      width:100%; background:#0a0f1a; color:var(--text); border:1px solid var(--border);
      border-radius:12px; padding:12px; outline:none;
    }
    input[type="file"]{width:100%; color:var(--muted)}
    textarea{min-height:120px; resize:vertical}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button{
      background:var(--accent); color:#052e16; border:0; padding:12px 16px; border-radius:12px;
      font-weight:700; cursor:pointer; transition:transform .04s ease, opacity .2s ease;
    }
    button[disabled]{opacity:.5; cursor:not-allowed}
    button:active{transform:scale(.98)}
    .list{margin:10px 0 0; padding:0; list-style:none; max-height:220px; overflow:auto; border:1px solid var(--border); border-radius:12px}
    .item{padding:10px 12px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px dashed #162033}
    .item:last-child{border-bottom:0}
    .muted{color:var(--muted); font-size:13px}
    .pill{background:#0a1a12;color:#86efac;border:1px solid #134e4a;padding:4px 8px;border-radius:999px;font-size:12px}
    .status{margin-top:10px; min-height:20px; font-size:14px; color:#a5b4fc}
    .hr{height:1px;background:var(--border);margin:14px 0}
    .tiny{font-size:12px;color:#9ca3af}
    .footer{margin-top:20px;color:#94a3b8;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">üéôÔ∏è Voice Clone ‚Äî Upload, Save, Generate</h1>
    <p class="sub">Upload a sample + name ‚Üí save voice ‚Üí type text ‚Üí generate unlimited audio ‚Üí download MP3.</p>

    <div class="grid">
      <!-- Upload & Create Voice -->
      <section class="card">
        <h2>1) Upload sample & save voice</h2>
        <label for="vname">Voice Name</label>
        <input id="vname" type="text" placeholder="e.g. AliNarration" />

        <label for="afile">Audio Sample (WAV/MP3/M4A)</label>
        <input id="afile" type="file" accept="audio/*" />

        <div class="row" style="margin-top:12px">
          <button id="btnUpload">Upload & Create Voice</button>
          <span id="statusUpload" class="status"></span>
        </div>

        <div class="hr"></div>
        <p class="tiny">
          Backend endpoint expected: <code>POST /api/upload (multipart: file, name)</code><br/>
          Should return JSON like: <code>{"name":"AliNarration","voice_id":"xxxx","createdAt":"..."}</code>
        </p>
      </section>

      <!-- Voices & Generate -->
      <section class="card">
        <h2>2) Saved voices & Generate</h2>
        <div class="row">
          <button id="btnRefresh">Refresh Voices</button>
          <span class="muted">Select a saved voice, type text, generate MP3.</span>
        </div>

        <ul id="voiceList" class="list"></ul>

        <label for="gtext" style="margin-top:12px">Text to Speak</label>
        <textarea id="gtext" placeholder="Type the narration text here..."></textarea>

        <div class="row" style="margin-top:12px">
          <button id="btnGenerate">Generate & Download</button>
          <span id="statusSpeak" class="status"></span>
        </div>

        <div class="hr"></div>
        <p class="tiny">
          Backend endpoints expected:
          <br/>‚Ä¢ <code>GET /api/voices</code> ‚Üí <code>[{ "name":"AliNarration","voice_id":"...", "createdAt":"..." }]</code>
          <br/>‚Ä¢ <code>POST /api/speak</code> (JSON: <code>{voice_id,text}</code>) ‚Üí returns <strong>audio/mpeg</strong> stream
        </p>
      </section>
    </div>

    <p class="footer">‚ö†Ô∏è Don‚Äôt expose provider API keys in the browser. Call providers from your backend only. Get consent from the speaker.</p>
  </div>

  <script>
    const els = {
      vname: document.getElementById('vname'),
      afile: document.getElementById('afile'),
      btnUpload: document.getElementById('btnUpload'),
      statusUpload: document.getElementById('statusUpload'),

      btnRefresh: document.getElementById('btnRefresh'),
      voiceList: document.getElementById('voiceList'),
      gtext: document.getElementById('gtext'),
      btnGenerate: document.getElementById('btnGenerate'),
      statusSpeak: document.getElementById('statusSpeak')
    };

    let selectedVoice = null;

    function setBusy(btn, statusEl, msg){
      if(btn){ btn.disabled = true; }
      if(statusEl){ statusEl.textContent = msg || '...'; }
    }
    function clearBusy(btn, statusEl, msgOk){
      if(btn){ btn.disabled = false; }
      if(statusEl){ statusEl.textContent = msgOk || ''; }
    }
    function showError(statusEl, err){
      if(statusEl){ statusEl.textContent = 'Error: ' + (err?.message || err || 'Unknown'); }
    }

    // Build voice list UI
    function renderVoices(list){
      els.voiceList.innerHTML = '';
      if(!Array.isArray(list) || !list.length){
        els.voiceList.innerHTML = '<li class="item"><span class="muted">No voices saved yet.</span></li>';
        selectedVoice = null;
        return;
      }
      list.forEach(v=>{
        const li = document.createElement('li');
        li.className = 'item';
        const left = document.createElement('div');
        const name = document.createElement('div');
        name.textContent = v.name || '(unnamed)';
        const meta = document.createElement('div');
        meta.className = 'muted';
        meta.textContent = 'ID: ' + (v.voice_id || '‚Äî');
        left.appendChild(name); left.appendChild(meta);

        const right = document.createElement('div');
        const pick = document.createElement('button');
        pick.textContent = selectedVoice && selectedVoice.voice_id === v.voice_id ? 'Selected' : 'Select';
        pick.style.background = selectedVoice && selectedVoice.voice_id === v.voice_id ? '#60a5fa' : '';
        pick.onclick = ()=>{
          selectedVoice = v;
          renderVoices(list);
        };

        const badge = document.createElement('span');
        badge.className = 'pill';
        badge.textContent = (v.createdAt ? new Date(v.createdAt).toLocaleString() : 'saved');

        right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
        right.appendChild(badge); right.appendChild(pick);

        li.appendChild(left); li.appendChild(right);
        els.voiceList.appendChild(li);
      });
    }

    async function fetchVoices(){
      try{
        const res = await fetch('/api/voices');
        if(!res.ok) throw new Error('Voices fetch failed');
        const data = await res.json();
        renderVoices(data);
      }catch(err){
        renderVoices([]);
        console.error(err);
      }
    }

    els.btnRefresh.addEventListener('click', fetchVoices);
    window.addEventListener('DOMContentLoaded', fetchVoices);

    // Upload & create voice
    els.btnUpload.addEventListener('click', async ()=>{
      const name = els.vname.value.trim();
      const file = els.afile.files?.[0];
      if(!name) return alert('Please enter a voice name.');
      if(!file) return alert('Please choose an audio file.');

      const fd = new FormData();
      fd.append('name', name);
      fd.append('file', file);

      try{
        setBusy(els.btnUpload, els.statusUpload, 'Uploading & creating voice...');
        const res = await fetch('/api/upload', { method:'POST', body: fd });
        const json = await res.json().catch(()=> ({}));
        if(!res.ok) throw new Error(json.message || res.statusText);
        els.vname.value = '';
        els.afile.value = '';
        clearBusy(els.btnUpload, els.statusUpload, 'Saved ‚úî');
        fetchVoices();
      }catch(err){
        showError(els.statusUpload, err);
        clearBusy(els.btnUpload);
      }
    });

    // Generate & download
    els.btnGenerate.addEventListener('click', async ()=>{
      if(!selectedVoice) return alert('Select a saved voice first.');
      const text = els.gtext.value.trim();
      if(!text) return alert('Type some text to speak.');

      try{
        setBusy(els.btnGenerate, els.statusSpeak, 'Generating audio...');
        const res = await fetch('/api/speak', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ voice_id: selectedVoice.voice_id, text })
        });
        if(!res.ok){
          const j = await res.json().catch(()=> ({}));
          throw new Error(j.message || res.statusText);
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${selectedVoice.name || 'voice'}-${Date.now()}.mp3`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        clearBusy(els.btnGenerate, els.statusSpeak, 'Done ‚úî');
      }catch(err){
        showError(els.statusSpeak, err);
        clearBusy(els.btnGenerate);
      }
    });
  </script>
</body>
</html>
