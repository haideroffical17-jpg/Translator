<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Creator Studio - Ultra Fast</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #10b981; /* Emerald-500 */
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
        
        /* Audio Player Customization */
        audio {
            filter: invert(1) hue-rotate(180deg);
            opacity: 0.9;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-[#0B1120] text-white font-sans h-screen flex flex-col overflow-hidden">

    <!-- ================= VIEWS CONTAINER ================= -->
    <div id="app-container" class="w-full h-full relative">

        <!-- 1. LANDING PAGE VIEW -->
        <div id="landing-view" class="absolute inset-0 flex flex-col items-center justify-center p-6 z-10 transition-opacity duration-500">
            
            <!-- Background Glows -->
            <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-indigo-900/20 rounded-full blur-3xl pointer-events-none"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-emerald-900/20 rounded-full blur-3xl pointer-events-none"></div>

            <!-- Badge -->
            <div class="bg-[#1E293B] border border-slate-700/50 px-4 py-1.5 rounded-full text-[10px] font-bold tracking-widest text-indigo-300 uppercase mb-6 shadow-lg">
                Powered by Grow with Haider
            </div>

            <!-- Title -->
            <div class="text-center mb-16 space-y-2">
                <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-white">
                    AI Creator Studio
                </h1>
                <p class="text-slate-400 text-lg font-medium">
                    Professional Tools Suite
                </p>
            </div>

            <!-- Card -->
            <div class="w-full max-w-md">
                <div id="open-tool-btn" class="group relative bg-[#162032] border border-slate-800 rounded-3xl p-10 hover:border-emerald-500/50 transition-all duration-300 hover:shadow-2xl hover:shadow-emerald-900/20 cursor-pointer transform hover:-translate-y-1">
                    <div class="absolute inset-0 bg-gradient-to-b from-emerald-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-3xl"></div>
                    
                    <div class="flex flex-col items-center text-center space-y-8 relative z-10">
                        <div class="w-20 h-20 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-500/30 group-hover:scale-110 transition-transform duration-300">
                            <i data-lucide="mic" class="w-10 h-10 text-white"></i>
                        </div>
                        
                        <div class="space-y-3">
                            <h3 class="text-2xl font-bold text-white">Text to Speech Pro</h3>
                            <p class="text-slate-400 text-base leading-relaxed">
                                30+ Premium Voices. Unlimited Text. <br/>Instant WAV Download.
                            </p>
                        </div>

                        <button class="flex items-center gap-2 px-6 py-2 bg-emerald-500/10 text-emerald-400 rounded-full text-sm font-bold group-hover:bg-emerald-500 group-hover:text-white transition-all">
                            Open Tool <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. TOOL VIEW (Hidden Initially) -->
        <div id="tool-view" class="absolute inset-0 flex flex-col bg-[#0B1120] hidden opacity-0 transition-opacity duration-500">
            
            <!-- Navbar -->
            <div class="border-b border-slate-800 bg-[#0F172A]/80 backdrop-blur-md sticky top-0 z-20">
                <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                    <button id="back-btn" class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i> Back
                    </button>
                    <h1 class="text-lg font-bold text-white flex items-center gap-2">
                        <span class="bg-emerald-500/10 text-emerald-400 p-1.5 rounded-lg"><i data-lucide="mic" class="w-4 h-4"></i></span>
                        Text to Speech Pro
                    </h1>
                    <button id="settings-btn" class="p-2 rounded-full hover:bg-slate-800 text-slate-400 transition-colors relative">
                        <i data-lucide="settings" class="w-5 h-5"></i>
                        <span id="key-indicator" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                </div>
            </div>

            <!-- Tool Content -->
            <div class="flex-1 p-4 md:p-8 max-w-6xl mx-auto w-full grid lg:grid-cols-2 gap-6 overflow-y-auto">
                
                <!-- Left: Input -->
                <div class="flex flex-col gap-4 h-full">
                    <div class="bg-[#1E293B] border border-slate-700 rounded-3xl p-1 flex-1 flex flex-col shadow-xl min-h-[300px]">
                        <textarea id="text-input" class="flex-1 w-full bg-transparent text-lg p-6 resize-none outline-none text-slate-200 placeholder:text-slate-600" placeholder="Paste your script here (Unlimited)..."></textarea>
                        <div class="px-6 py-3 border-t border-slate-700/50 text-right text-xs text-slate-500 font-mono">
                            <span id="char-count">0</span> characters
                        </div>
                    </div>
                </div>

                <!-- Right: Controls -->
                <div class="flex flex-col gap-4">
                    
                    <!-- Voice Selector -->
                    <div class="bg-[#1E293B] border border-slate-700 rounded-3xl overflow-hidden flex flex-col h-[450px] shadow-xl">
                        <div class="px-6 py-4 border-b border-slate-700 bg-[#1E293B] sticky top-0 z-10 flex justify-between items-center">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Controls</span>
                            <i data-lucide="sliders-horizontal" class="w-4 h-4 text-slate-500"></i>
                        </div>

                        <!-- Sliders -->
                        <div class="p-6 space-y-6 bg-[#162032] border-b border-slate-700">
                            <div>
                                <div class="flex justify-between mb-2 text-xs font-medium">
                                    <span class="text-slate-400 uppercase">Speed (Preview Only)</span>
                                    <span id="speed-val" class="text-emerald-400">1.0x</span>
                                </div>
                                <input type="range" id="speed-range" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full">
                            </div>
                        </div>

                        <div class="px-6 py-2 bg-[#1E293B] text-xs font-bold text-slate-400 uppercase tracking-wider">
                            Voices
                        </div>

                        <div id="voice-list" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                            <!-- JS will populate this -->
                        </div>
                    </div>

                    <!-- Action Box -->
                    <div class="bg-[#1E293B] border border-slate-700 rounded-3xl p-6 shadow-xl relative overflow-hidden">
                        <div class="absolute -top-10 -right-10 w-32 h-32 bg-emerald-500/20 rounded-full blur-3xl"></div>
                        
                        <div class="relative z-10 space-y-4">
                            <!-- Progress -->
                            <div id="progress-container" class="hidden space-y-2">
                                <div class="flex justify-between text-xs font-bold text-emerald-400">
                                    <span id="progress-text">Initializing...</span>
                                    <span id="progress-pct">0%</span>
                                </div>
                                <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div id="progress-bar" class="h-full bg-emerald-500 transition-all duration-300 w-0"></div>
                                </div>
                            </div>

                            <!-- Generate Button -->
                            <button id="generate-btn" class="w-full py-4 bg-emerald-500 hover:bg-emerald-400 text-[#0B1120] font-bold rounded-xl shadow-lg shadow-emerald-900/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                                <i data-lucide="wand-2" class="w-5 h-5"></i> Generate Audio
                            </button>

                            <!-- Result Area -->
                            <div id="result-container" class="hidden animate-in fade-in slide-in-from-bottom-2 space-y-3 pt-2">
                                <div class="bg-slate-900/50 p-2 rounded-xl border border-slate-700">
                                    <audio id="audio-player" controls class="w-full h-8"></audio>
                                </div>
                                <a id="download-link" href="#" download class="flex items-center justify-center gap-2 w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-medium transition-colors">
                                    <i data-lucide="download" class="w-4 h-4"></i> Download File
                                </a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-start justify-center pt-20 hidden">
        <div class="bg-[#1E293B] border border-slate-700 rounded-2xl p-6 w-full max-w-md shadow-2xl transform transition-all scale-100">
            <h3 class="text-white font-bold mb-4 flex items-center gap-2">
                <i data-lucide="key" class="w-4 h-4 text-indigo-400"></i> API Key Manager
            </h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <label class="text-xs text-slate-400">Paste Gemini API Key</label>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-1 hover:underline">
                        Get API Key <i data-lucide="external-link" class="w-3 h-3"></i>
                    </a>
                </div>
                <input id="api-key-input" type="password" placeholder="Paste Gemini API Key..." class="w-full bg-[#0B1120] border border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo-500 text-white">
                <div class="flex gap-2">
                    <button id="save-key-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded-xl text-sm font-bold">Add Key</button>
                    <button id="close-settings-btn" class="px-4 bg-slate-700 hover:bg-slate-600 text-white rounded-xl text-sm">Close</button>
                </div>
                <div class="text-xs text-slate-500 pt-2 flex justify-between items-center">
                    <span id="active-keys-count">Active Keys: 0</span>
                    <button id="clear-keys-btn" class="text-red-400 hover:underline">Clear All</button>
                </div>
                <p class="text-[10px] text-slate-500 italic">*Add multiple keys to bypass daily limits automatically.</p>
            </div>
        </div>
    </div>

    <!-- ERROR TOAST -->
    <div id="error-toast" class="fixed bottom-6 right-6 max-w-sm bg-[#1E293B] border-l-4 border-red-500 shadow-2xl rounded-lg p-4 hidden z-50">
        <div class="flex items-start gap-3">
            <i data-lucide="alert-circle" class="w-5 h-5 text-red-500 mt-0.5"></i>
            <div>
                <h3 class="font-bold text-red-400 text-sm">Error</h3>
                <p id="error-msg" class="text-xs text-slate-300 mt-1">Something went wrong.</p>
            </div>
            <button id="close-toast" class="ml-auto text-slate-400 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONSTANTS ---
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        // Safe chunk size
        const CHUNK_SIZE = 4500;
        const VOICES = [
            { id: "Fenrir", gender: "Male", desc: "Deep & Calm" },
            { id: "Kore", gender: "Female", desc: "Soothing & Clear" },
            { id: "Puck", gender: "Male", desc: "Energetic" },
            { id: "Aoede", gender: "Female", desc: "Warm & Friendly" },
            { id: "Charon", gender: "Male", desc: "Deep & Authoritative" },
            { id: "Zephyr", gender: "Male", desc: "Smooth & Balanced" },
            { id: "Leda", gender: "Female", desc: "Soft & Gentle" },
            { id: "Orus", gender: "Male", desc: "Confident" },
            { id: "Umbriel", gender: "Male", desc: "Steady & Neutral" },
            { id: "Iapetus", gender: "Male", desc: "Serious & Deep" }
        ];

        // --- STATE ---
        let state = {
            text: "",
            selectedVoiceId: "Fenrir",
            apiKeys: [],
            currentKeyIndex: 0,
            isGenerating: false,
            previewAudio: null,
            speed: 1.0
        };

        // --- ELEMENTS ---
        const els = {
            landingView: document.getElementById('landing-view'),
            toolView: document.getElementById('tool-view'),
            openToolBtn: document.getElementById('open-tool-btn'),
            backBtn: document.getElementById('back-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            apiKeyInput: document.getElementById('api-key-input'),
            saveKeyBtn: document.getElementById('save-key-btn'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            clearKeysBtn: document.getElementById('clear-keys-btn'),
            activeKeysCount: document.getElementById('active-keys-count'),
            keyIndicator: document.getElementById('key-indicator'),
            textInput: document.getElementById('text-input'),
            charCount: document.getElementById('char-count'),
            voiceList: document.getElementById('voice-list'),
            speedRange: document.getElementById('speed-range'),
            speedVal: document.getElementById('speed-val'),
            generateBtn: document.getElementById('generate-btn'),
            progressContainer: document.getElementById('progress-container'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            progressPct: document.getElementById('progress-pct'),
            resultContainer: document.getElementById('result-container'),
            audioPlayer: document.getElementById('audio-player'),
            downloadLink: document.getElementById('download-link'),
            errorToast: document.getElementById('error-toast'),
            errorMsg: document.getElementById('error-msg'),
            closeToast: document.getElementById('close-toast')
        };

        // --- INIT ---
        function init() {
            lucide.createIcons();
            renderVoices();
            
            const storedKeys = localStorage.getItem("multi_api_keys");
            if (storedKeys) {
                state.apiKeys = JSON.parse(storedKeys);
                updateKeysCount();
            }

            // Event Listeners
            els.openToolBtn.onclick = () => switchView('tool');
            els.backBtn.onclick = () => switchView('landing');
            els.settingsBtn.onclick = () => toggleSettings(true);
            els.closeSettingsBtn.onclick = () => toggleSettings(false);
            els.saveKeyBtn.onclick = saveKey;
            els.clearKeysBtn.onclick = clearKeys;
            els.textInput.oninput = (e) => {
                state.text = e.target.value;
                els.charCount.innerText = state.text.length;
            };
            els.speedRange.oninput = (e) => {
                state.speed = parseFloat(e.target.value);
                els.speedVal.innerText = state.speed + 'x';
            };
            els.generateBtn.onclick = generateAudio;
            els.closeToast.onclick = () => els.errorToast.classList.add('hidden');
        }

        // --- UI LOGIC ---
        function switchView(view) {
            if (view === 'tool') {
                els.landingView.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => els.landingView.classList.add('hidden'), 300);
                
                els.toolView.classList.remove('hidden');
                setTimeout(() => els.toolView.classList.remove('opacity-0'), 50);
            } else {
                els.toolView.classList.add('opacity-0');
                setTimeout(() => els.toolView.classList.add('hidden'), 300);
                
                els.landingView.classList.remove('hidden');
                setTimeout(() => els.landingView.classList.remove('opacity-0', 'pointer-events-none'), 50);
            }
        }

        function toggleSettings(show) {
            if(show) els.settingsModal.classList.remove('hidden');
            else els.settingsModal.classList.add('hidden');
        }

        function renderVoices() {
            els.voiceList.innerHTML = '';
            VOICES.forEach(voice => {
                const div = document.createElement('div');
                const isActive = state.selectedVoiceId === voice.id;
                
                div.className = `p-3 rounded-xl cursor-pointer transition-all flex items-center justify-between group ${isActive ? 'bg-emerald-600/20 border border-emerald-500/50' : 'hover:bg-slate-800 border border-transparent'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${isActive ? 'bg-emerald-500 text-white' : 'bg-slate-700 text-slate-400'}">
                            ${voice.id[0]}
                        </div>
                        <div>
                            <h4 class="text-sm font-bold ${isActive ? 'text-emerald-400' : 'text-slate-300'}">${voice.id}</h4>
                            <p class="text-[10px] text-slate-500">${voice.gender} â€¢ ${voice.desc}</p>
                        </div>
                    </div>
                    <button class="preview-btn p-2 rounded-full hover:bg-slate-700 text-slate-400 hover:text-emerald-400 transition-colors">
                        <i data-lucide="play" class="w-3 h-3 fill-current"></i>
                    </button>
                `;

                // Click Selection
                div.onclick = () => {
                    state.selectedVoiceId = voice.id;
                    renderVoices();
                };

                // Preview Click
                const prevBtn = div.querySelector('.preview-btn');
                prevBtn.onclick = (e) => {
                    e.stopPropagation();
                    playPreview(voice.id);
                };

                els.voiceList.appendChild(div);
            });
            lucide.createIcons();
        }

        // --- KEY MANAGEMENT ---
        function saveKey() {
            const key = els.apiKeyInput.value.trim();
            if(key) {
                state.apiKeys.push(key);
                localStorage.setItem("multi_api_keys", JSON.stringify(state.apiKeys));
                els.apiKeyInput.value = "";
                updateKeysCount();
                alert("Key Added!");
            }
        }

        function clearKeys() {
            if(confirm("Remove all saved keys?")) {
                state.apiKeys = [];
                localStorage.removeItem("multi_api_keys");
                updateKeysCount();
            }
        }

        function updateKeysCount() {
            els.activeKeysCount.innerText = `Active Keys: ${state.apiKeys.length}`;
            if(state.apiKeys.length > 0) {
                els.keyIndicator.classList.remove('bg-red-500');
                els.keyIndicator.classList.add('bg-green-500');
            } else {
                els.keyIndicator.classList.add('bg-red-500');
                els.keyIndicator.classList.remove('bg-green-500');
            }
        }

        // --- CORE GENERATION (PARALLEL) ---
        async function generateAudio() {
            if (!state.text.trim()) return showError("Please enter some text.");
            if (state.apiKeys.length === 0) {
                toggleSettings(true);
                return showError("Please add an API Key first!");
            }

            setIsGenerating(true);
            
            try {
                const chunks = chunkText(state.text);
                
                // PARALLEL REQUESTS LOGIC
                let completed = 0;
                const promises = chunks.map(async (chunk, index) => {
                    const buffer = await fetchWithRotation(chunk, state.selectedVoiceId);
                    
                    completed++;
                    const pct = Math.round((completed / chunks.length) * 100);
                    // Safe UI Update
                    requestAnimationFrame(() => {
                        els.progressBar.style.width = `${pct}%`;
                        els.progressPct.innerText = `${pct}%`;
                    });
                    
                    return { index, buffer };
                });

                const results = await Promise.all(promises);
                
                // Re-order
                results.sort((a, b) => a.index - b.index);
                const buffers = results.map(r => r.buffer);

                // Merge
                const finalBlob = mergeBuffers(buffers);
                const url = URL.createObjectURL(finalBlob);
                
                // Update Result UI
                els.audioPlayer.src = url;
                els.downloadLink.href = url;
                els.downloadLink.download = `tts-${state.selectedVoiceId}-${Date.now()}.wav`;
                els.resultContainer.classList.remove('hidden');

            } catch (err) {
                showError(err.message);
            } finally {
                setIsGenerating(false);
            }
        }

        async function playPreview(voiceId) {
            if (state.apiKeys.length === 0) {
                toggleSettings(true);
                return showError("Please add an API Key to preview.");
            }

            if (state.previewAudio) {
                state.previewAudio.pause();
            }

            try {
                const buffer = await fetchWithRotation("Hello.", voiceId);
                const blob = createWavFromBuffer(buffer);
                const url = URL.createObjectURL(blob);
                const audio = new Audio(url);
                
                audio.playbackRate = state.speed;
                audio.play();
                state.previewAudio = audio;
            } catch (err) {
                showError("Preview Error: " + err.message);
            }
        }

        // --- API LOGIC ---
        async function fetchWithRotation(text, voiceId) {
            let attempts = 0;
            while (attempts < state.apiKeys.length) {
                const key = state.apiKeys[state.currentKeyIndex];
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${key}`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: { 
                                    voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceId } } 
                                }
                            }
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 429 || response.status === 403) {
                            state.currentKeyIndex = (state.currentKeyIndex + 1) % state.apiKeys.length;
                            attempts++;
                            continue;
                        }
                        throw new Error(await response.text());
                    }

                    const data = await response.json();
                    const b64 = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (!b64) throw new Error("No audio data returned.");

                    const bin = atob(b64);
                    const bytes = new Uint8Array(bin.length);
                    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
                    return bytes.buffer;

                } catch (e) {
                    if (e.message.includes("Quota")) {
                        state.currentKeyIndex = (state.currentKeyIndex + 1) % state.apiKeys.length;
                        attempts++;
                    } else {
                        throw e;
                    }
                }
            }
            throw new Error("All API Keys exhausted.");
        }

        // --- WAV & UTILS ---
        function chunkText(str) {
            const chunks = [];
            let current = "";
            const sentences = str.match(/[^.!?]+[.!?]+|[^.!?]+$/g) || [str];
            sentences.forEach(s => {
                if(current.length + s.length < CHUNK_SIZE) current += s;
                else { if(current) chunks.push(current); current = s; }
            });
            if(current) chunks.push(current);
            return chunks;
        }

        function isWav(buffer) {
            if (buffer.byteLength < 4) return false;
            const view = new DataView(buffer);
            return view.getUint32(0, false) === 0x52494646; 
        }

        function findDataOffset(buffer) {
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.length - 4; i++) {
                if (bytes[i]===0x64 && bytes[i+1]===0x61 && bytes[i+2]===0x74 && bytes[i+3]===0x61) {
                    return i + 8; 
                }
            }
            return 44; 
        }

        function mergeBuffers(buffers) {
            if (buffers.length === 0) return new Blob([]);
            let totalLen = 0;
            const parts = [];
            buffers.forEach(b => {
                let offset = 0;
                if (isWav(b)) offset = findDataOffset(b);
                const part = b.slice(offset);
                parts.push(part);
                totalLen += part.byteLength;
            });
            const header = createWavHeader(totalLen);
            return new Blob([header, ...parts], { type: 'audio/wav' });
        }

        function createWavFromBuffer(buffer) {
            if (isWav(buffer)) return new Blob([buffer], { type: 'audio/wav' });
            const header = createWavHeader(buffer.byteLength);
            return new Blob([header, buffer], { type: 'audio/wav' });
        }

        function createWavHeader(len) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + len, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, 24000, true);
            view.setUint32(28, 48000, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, len, true);
            return buffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
        }

        function setIsGenerating(val) {
            state.isGenerating = val;
            if (val) {
                els.generateBtn.disabled = true;
                els.generateBtn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Generating...`;
                els.generateBtn.classList.add('opacity-70');
                els.progressContainer.classList.remove('hidden');
                els.resultContainer.classList.add('hidden');
            } else {
                els.generateBtn.disabled = false;
                els.generateBtn.innerHTML = `<i data-lucide="wand-2" class="w-5 h-5"></i> Generate Audio`;
                els.generateBtn.classList.remove('opacity-70');
            }
            lucide.createIcons();
        }

        function showError(msg) {
            els.errorMsg.innerText = msg;
            els.errorToast.classList.remove('hidden');
            setTimeout(() => els.errorToast.classList.add('hidden'), 8000);
        }

        // Start App
        init();

    </script>
</body>
</html>
